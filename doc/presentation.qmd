---
title: "Group 11 - Gene expression in colorectal cancer"
author: "Eleni-Sofia Tseperi (s240066),	Johanne Lund	(s233246), Marie Picquet	(s233736), Eglantine Anton	(s233242), Qiuyan Wu	(s241063)"
format:
  revealjs:
    code-line-numbers: true
    scrollable: true
    smaller: true
    scoll: true
    theme: night
    transition: slide
    incremental: true 
editor: visual
---

```{r}
library(tidyverse)
library(here)
library(readr)
library(broom)
library(here)
library(ggrepel)
```

## Introduction

-   Background

    -   Colorectal cancer (CRC) is a major cause of cancer mortality

    -   Gene expression analysis can help identify dysregulated genes

-   Goal of the project

    -   Investigate xxx

    -   Model xxx

-   Data sets

    -   Gene expression level for 1935 genes

    -   Patient information for 62 patients

    -   Artificially made dirty and messy to increase the difficulty of the projects

## Methods overview

(incl run-all file), raw, load, making dirty

## Methods - Tidy, clean & augment

::: columns
### Tidy

::: {.column width="50%" height="auto" style="font-size: 22px"}
Expression data

-   The columns represent observations and the rows variables

    -   Pivot the data set

    ```{r}
    #| echo: true
    #| eval: false
    expr_data <- expr_data |>
      mutate(ID_GENE = ID_REF) |>
      select(-ID_REF, -...1) |> 
      pivot_longer(-c(ID_GENE), 
                   names_to = "ID_REF", 
                   values_to = "Gene expression level") |>
      pivot_wider(names_from = ID_GENE, 
                  values_from = "Gene expression level") 
    ```
:::

::: {.column width="50%" height="auto" style="font-size: 22px"}
Patient data

-   Separate `DFS event/Adj_Radio/Adj_Chem` into 3 distinct variables

-   Convert `DFS (in years and months)` into months to have only value per observation
:::

::: {.column align="center" width="100%" height="auto" style="font-size: 22px" align="center"}
:::

Combine the two data sets by joining on the patient ID
:::

### Clean

::: columns
::: {.column width="50%" height="auto" style="font-size: 22px"}
**Cleaning row value**

-   Handle Missing Values

-   Standardize Gender Labels

-   Fix Invalid Age Values

-   Removed rows where ID_REF does not start with GSM
:::

::: {.column width="50%" height="auto" style="font-size: 22px"}
**Cleaning column names**

-   Remove `gene\_` at the beginning of all the gene names

-   Remove the units from the names:

-   Replace spaces by \_:
:::
:::

### Augment

::: columns
::: {.column width="30%" height="auto" style="font-size: 22px"}
-   Create an `age_group` variable

```{r}
#| echo: true
#| eval: false
data <- data |>mutate(Age_group = cut(Age, breaks = seq(10, 100, by = 10)))
```
:::

::: {.column width="30%" height="auto" style="font-size: 22px"}
-   Create a `metastasis` variable

```{r}
#| echo: true
#| eval: false
data <- data |>
  mutate(No_stage = case_when(Dukes_stage == "A" ~ 1,
                            Dukes_stage == "B" ~ 2,
                            Dukes_stage == "C" ~ 3,
                            Dukes_stage == "D" ~ 4),
         metastasis = case_when(No_stage <= 3 ~ 0,
                                No_stage > 3 ~ 1))
```
:::

::: {.column width="30%" height="auto" style="font-size: 22px"}
-   Create an `DFS_label` variable
:::

```{r}
#| echo: true
#| eval: false
data <- data |>
  mutate(DFS_label = case_when(DFS_event == 0 ~ "No return of disease",
                            DFS_event == 1 ~ "Return of disease"), .after = DFS_event)
```
:::

## Methods - Describe

## Results - Data description

## Methods - Analysis 1

### Principal component analysis (PCA)

We are finding tendencies in the data, looking at its spread, and trying to visualise the clustering of Duke stages, gender, or location of the tumour.

::: columns
::: {.column width="50%"}
![](images/05_pca_scree_plot-01.png)

![](images/05_pca_gender.png)
:::

::: {.column width="50%"}
![](images/05_pca_Dukes_stages.png)

![](images/05_pca_location.png)
:::
:::

## Methods - Analysis 2

### Aim

Identify genes that are significantly up- or down-regulated between the patients with/without metastasis

::: columns
::: {.column width="40%" style="font-size: 22px"}
1.  Pivot the data
2.  Group per gene and nest the data
3.  Fit a linear model per gene
4.  Tidy the fitted model and get confidence intervals
5.  Extract the model parameters and correct for multiple testing
:::

::: {.column width="60%" style="font-size: 22px"}
```{r}
#| echo: true
#| eval: false
data_long_nested <- data |>
  select(ends_with("_at"), metastasis) |> 
  pivot_longer(cols = ends_with("_at"), 
               names_to = "gene", 
               values_to = "log2_expr_level") |> 
  group_by(gene) |> 
  nest() |> 
  ungroup()

data_long_nested <- data_long_nested |> 
  group_by(gene) |> 
  mutate(model_object = map(.x = data,
                   .f = ~lm(formula = log2_expr_level ~ metastasis,
                            data = .x))) |> 
  ungroup() |> 
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~tidy(x =.x,
                                            conf.int = TRUE,
                                            conf.level = 0.95)))

estimates <- data_long_nested |> 
  unnest(model_object_tidy) |> 
  filter(term == "metastasis") |> 
  select("gene", "p.value", "estimate", "conf.low", "conf.high") |> 
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(q.value > 0.05 ~ "no",
                                    q.value <= 0.05 ~ "yes"))

```
:::
:::

## Methods - Analysis 3

## Results - Analysis 1 & 2

::: columns
::: {.column width="50%" style="font-size: 22px"}
Analysis 1
:::

::: {.column width="50%" style="font-size: 22px"}
Analysis 2

-   No gene found to be significant after multiple testing

-   Use the genes with p\<0.01 for the plot

-   20 genes (12 up regulated, 8 down regulated)

![](images/06_analysis_volcano-01.png){width="416"}
:::
:::

## Results analysis 3 & Discussion
